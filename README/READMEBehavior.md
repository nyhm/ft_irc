## 理想の挙動

テスト観点ごとに

1. 送るコマンド（nc 例）
2. 期待挙動（代表的な数値リプライ／状態変化）
   を示す。

前提:

* サーバ: `./ircserv 6667 pass`
* nc は CRLF 送信用に `-C` を使用
* クライアントA=alice、クライアントB=bob、クライアントC=carol

---



## 1. 接続・認証・基本応答

### 1-1 認証成功

**送信（A）**

```
nc -C 127.0.0.1 6667
PASS pass
NICK alice
USER alice 0 * :Alice
```

**期待挙動**
`001 RPL_WELCOME`（MOTD があれば `372...376`、なければ `422`）。以後コマンド受理可能。

### 1-2 パスワード不一致

**送信**

```
PASS wrong
NICK bad
USER bad 0 * :Bad
```

**期待挙動**
`464 ERR_PASSWDMISMATCH` → 登録拒否（切断されても良い）。

### 1-3 ニック競合

**送信（B）**

```
nc -C 127.0.0.1 6667
PASS pass
NICK alice
```

**期待挙動**
`433 ERR_NICKNAMEINUSE`。別ニック要求。

### 1-4 ニック変更

**送信（A）**

```
NICK alice2
```

**期待挙動**
全参加チャンネルへ `:alice!~... NICK :alice2` ブロードキャスト。

### 1-5 PING/PONG

**送信（A）**

```
PING :123
```

**期待挙動**
`PONG :123`。アイドル切断回避確認。

---

## 2. チャンネル参加・一覧・退出

### 2-1 JOIN と NAMES

**送信（A）**

```
JOIN #test
```

**期待挙動**
`JOIN`通知、自分宛に `353 RPL_NAMREPLY` と `366 RPL_ENDOFNAMES`。トピック未設定なら `331 RPL_NOTOPIC`。

### 2-2 ブロードキャスト

**送信（B）**

```
PASS pass
NICK bob
USER bob 0 * :Bob
JOIN #test
PRIVMSG #test :hello
```

**期待挙動**
A・B双方が在室。Bの発言はAに届く（`:@bob PRIVMSG #test :hello`）。自分自身に二重送信はしない実装が一般的。

### 2-3 PART

**送信（A）**

```
PART #test :bye
```

**期待挙動**
`PART`がチャンネルに通知。Aは #test から除外。

---

## 3. 権限・MODE・TOPIC・INVITE・KICK

事前: A をオペにするため、初期作成者を A とし B を後参加にするか、サーバ仕様に従い昇格。

### 3-1 非オペ操作の拒否

**送信（B）**

```
MODE #test +t
```

**期待挙動**
`482 ERR_CHANOPRIVSNEEDED`。

### 3-2 オペ付与/剥奪 (+o/-o)

**送信（A）**

```
MODE #test +o bob
MODE #test -o bob
```

**期待挙動**
成功時 `MODE` がチャンネルに通知。対象の権限が反映。

### 3-3 招待制の切替 (+i/-i) と INVITE

**送信（A）**

```
MODE #test +i
```

**送信（C）**

```
PASS pass
NICK carol
USER carol 0 * :Carol
JOIN #test
```

**期待挙動**
C は `473 ERR_INVITEONLYCHAN` で拒否。
**送信（A）**

```
INVITE carol #test
```

**送信（C）**

```
JOIN #test
```

**期待挙動**
C が参加成功。

### 3-4 TOPIC と +t

**送信（A）**

```
MODE #test +t
TOPIC #test :Welcome
```

**期待挙動**
トピック変更成功（`332 RPL_TOPIC` 通知）。
**送信（B）**

```
TOPIC #test :nope
```

**期待挙動**
`482 ERR_CHANOPRIVSNEEDED`。

### 3-5 キー (+k/-k) と入室検証

**送信（A）**

```
MODE #test +k secret
```

**送信（B）**

```
PART #test
JOIN #test
```

**期待挙動**
B は `475 ERR_BADCHANNELKEY`。
**送信（B）**

```
JOIN #test secret
```

**期待挙動**
参加成功。
**送信（A）**

```
MODE #test -k
```

### 3-6 人数上限 (+l/-l)

**送信（A）**

```
MODE #test +l 2
```

**送信（C 以外の新規クライアント D）**

```
JOIN #test
```

**期待挙動**
`471 ERR_CHANNELISFULL`。
**送信（A）**

```
MODE #test -l
```

### 3-7 KICK

**送信（A）**

```
KICK #test bob :rule
```

**期待挙動**
B が #test から即時退出。B とチャンネルに `KICK` 通知。

---

## 4. 直接メッセージ（PRIVMSG ニック宛）

### 4-1 通常

**送信（A→B）**

```
PRIVMSG bob :hi
```

**期待挙動**
B が `:alice PRIVMSG bob :hi` を受信。

### 4-2 宛先不在

**送信（A）**

```
PRIVMSG nothere :hi
```

**期待挙動**
`401 ERR_NOSUCHNICK`。

---

## 5. エラー系・引数不足

### 5-1 引数不足

**送信（A）**

```
JOIN
```

**期待挙動**
`461 ERR_NEEDMOREPARAMS JOIN`。

### 5-2 不明モード

**送信（A）**

```
MODE #test +z
```

**期待挙動**
`472 ERR_UNKNOWNMODE z`。

### 5-3 未参加チャンネル操作

**送信（B）**

```
MODE #test +i
```

**期待挙動**
`442 ERR_NOTONCHANNEL #test` または `482`（実装により前者を優先）。

---

## 6. 断片化・低帯域・フラッド耐性

### 6-1 断片化（課題例）

**送信（任意クライアント）**

```
nc -C 127.0.0.1 6667
com^Dman^Dd
```

**期待挙動**
`"command\r\n"` と同等に**1コマンドとして処理**。途中ではパースされない。

### 6-2 512バイト超（行長）

**送信（A）**
510バイト程度の本文を送信（例）:

```
PRIVMSG #test :<510バイトの文字列>
```

次に 513+ バイトも送信。
**期待挙動**
上限内は送信成功。超過時は切り捨て or エラー応答 or 切断のいずれでも**ハングしない・リークしない**こと（実装ポリシー一貫）。

### 6-3 受信停止（遅い消費者）とフラッド

**手順**
B を #test に参加 → 端末で B を一時停止（Ctrl+Z など）
**送信（A から大量送信）**

```
for i in $(seq 1 200); do echo "PRIVMSG #test :$i"; done | nc -C 127.0.0.1 6667
```

**期待挙動**
サーバはハングしない（`send` で詰まらない）。B を再開後もサーバ継続動作。メモリリークなし。

### 6-4 強制切断

**手順**
`nc` ウィンドウを閉じる / `kill -9`
**期待挙動**
サーバ側で FD/チャンネル状態がクリーンアップされ、他接続は継続。以後ブロードキャストに当該ユーザは含まれない。

---

## 7. 終了

### 7-1 QUIT

**送信（A）**

```
QUIT :bye
```

**期待挙動**
他参加者に `QUIT` 通知。サーバ側でリソース解放・リークなし。

---

## 参考メモ

* サーバ送信は**常に CRLF 終端**。受信は CRLF を区切りに**完全行のみ処理**。
* 代表数値リプライ:
  `001, 331/332, 353/366, 401, 403, 433, 442, 461, 471, 472, 473, 475, 482`。
* どのケースでも**プロセスが落ちない・固まらない・リークしない**ことを並行確認（`valgrind`/`leaks` 推奨）。





rgb(255,0,0)
具体的な要件に対する挙動rgb(255,0,0)
rgb(255,0,0)
---

## 1. 接続・認証系コマンド

### **NICK**

```
NICK <nickname>
```

* **意味**: ニックネームを設定／変更する。
* **挙動**:

  * サーバーは、そのニックが既に使われていないか確認する。
  * 使用中ならエラー `433 ERR_NICKNAMEINUSE` を返す。
  * 成功するとクライアントのニックが更新される。

---

### **USER**

```
USER <username> <hostname> <servername> :<realname>
```

* **意味**: 接続時にユーザー名と実名を登録する。
* **挙動**:

  * RFC準拠では `<hostname>` や `<servername>` は無視してもOK（サーバー側で設定）。
  * `:<realname>` はスペースを含められる。
  * **NICK と USER の両方が完了**したら認証成功 (`001` ウェルカムメッセージ)。

---

## 2. チャンネル参加・退出系

### **JOIN**

```
JOIN <channel> [<key>]
```

* **意味**: チャンネルに参加する。
* **挙動**:

  * チャンネルが存在しなければ作成され、自分がオペレーター（`@`）になる。
  * key（パスワード）付きの場合、合っていないと `475 ERR_BADCHANNELKEY`。
  * invite-only モードなら、INVITE されていないと `473 ERR_INVITEONLYCHAN`。

---

### **PART**

```
PART <channel> [<message>]
```

* **意味**: チャンネルから退出する。
* **挙動**:

  * 退出時、チャンネルにいる全員に通知。
  * チャンネルが空になればサーバーは削除してもよい。

---

## 3. メッセージ系

### **PRIVMSG**

```
PRIVMSG <target> :<message>
```

* **意味**: 個人またはチャンネルにメッセージ送信。
* **挙動**:

  * `<target>` が `#` で始まればチャンネル全員に（自分以外）。
  * 個人名ならそのユーザーだけに。
  * 送信できない状態ならエラー（例：+c モードのユーザーへは拒否）。

---

### **NOTICE**

```
NOTICE <target> :<message>
```

* **意味**: エラーレスポンスを返さない版の PRIVMSG。
* **挙動**:

  * 返答禁止がRFC仕様。BOTやサーバーメッセージで使用。

---

## 4. オペレーター専用（チャンネル管理）

### **KICK**

```
KICK <channel> <user> [<comment>]
```

* **意味**: 指定ユーザーをチャンネルから追放。
* **条件**: 実行者がそのチャンネルのオペレーターであること。
* **挙動**:

  * 強制的に `PART` させる。
  * 全員に通知。

---

### **INVITE**

```
INVITE <nickname> <channel>
```

* **意味**: Invite-only チャンネルにユーザーを招待。
* **挙動**:

  * 招待されたユーザーは `JOIN` できるようになる。
  * 成功時は `341 RPL_INVITING`。

---

### **TOPIC**

```
TOPIC <channel> [:<topic>]
```

* **意味**:

  * 引数あり → チャンネルのトピックを変更。
  * 引数なし → 現在のトピックを表示。
* **挙動**:

  * `+t` モードだとオペレーターのみ変更可能。

---

### **MODE**（チャンネル用）

```
MODE <channel> {[+|-]mode [params]}
```

* **意味**: チャンネル設定を変更。
* **必須モードと挙動**:

  * `+i` / `-i` : Invite-only の有効/無効。
  * `+t` / `-t` : トピック変更をOPのみに制限/解除。
  * `+k <key>` : チャンネルにパスワードを設定（`-k` で解除）。
  * `+o <nick>` : OP 権限を付与（`-o` で剥奪）。
  * `+l <count>` : ユーザー上限を設定（`-l` で解除）。

---

## 5. 情報取得系（デバッグや状態確認で便利）

### **WHO**

```
WHO <name>
```

* **意味**: チャンネルやユーザーの情報を一覧表示。

### **WHOIS**

```
WHOIS <nickname>
```

* **意味**: 特定ユーザーの詳細情報を表示。

### **NAMES**

```
NAMES <channel>
```

* **意味**: チャンネルにいる全ユーザーのリストを取得。

---

## まとめ表

| コマンド                | 主な用途      | 権限            |
| ------------------- | --------- | ------------- |
| NICK / USER         | 接続認証      | 全員            |
| JOIN / PART         | チャンネル出入り  | 全員            |
| PRIVMSG / NOTICE    | メッセージ送信   | 全員            |
| KICK                | 強制退出      | チャンネルOP       |
| INVITE              | 招待        | チャンネルOP       |
| TOPIC               | トピック表示・変更 | 全員 or OP（+t時） |
| MODE                | チャンネル設定   | OP（設定系）       |
| WHO / WHOIS / NAMES | 情報取得      | 全員            |
